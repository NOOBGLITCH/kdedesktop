stages:
  - debug
  - remote

variables:
  # Optional: This will be visible to scripts, but secure values must be in GitLab UI/API
  POWERSHELL_TELEMETRY_OPTOUT: "1"

debug_vars:
  stage: debug
  image: mcr.microsoft.com/powershell:latest
  script:
    - echo "=== Debugging Environment Variables ==="
    - pwsh -NoLogo -Command "Write-Host ('WINDOWS_USER: ' + $env:WINDOWS_USER)"
    - pwsh -NoLogo -Command "Write-Host ('WINDOWS_HOST: ' + $env:WINDOWS_HOST)"
    - pwsh -NoLogo -Command "Write-Host 'WINDOWS_PASS is set: ' + [string]::IsNullOrEmpty($env:WINDOWS_PASS)"

connect_windows:
  stage: remote
  image: mcr.microsoft.com/powershell:latest
  script:
    - echo "=== Attempting Remote Connection ==="
    # Create a secure password object
    - pwsh -NoLogo -Command "$secpass = ConvertTo-SecureString $env:WINDOWS_PASS -AsPlainText -Force; \
      $cred = New-Object System.Management.Automation.PSCredential ($env:WINDOWS_USER, $secpass); \
      Write-Host 'Credential object created'; \
      Invoke-Command -ComputerName $env:WINDOWS_HOST -Credential $cred -ScriptBlock { hostname; whoami }"
