stages:
  - debug
  - connect

variables:
  POWERSHELL_IMAGE: "mcr.microsoft.com/powershell:latest"

debug_gitlab_vars:
  stage: debug
  image: $POWERSHELL_IMAGE
  script:
    - |
      cat >/tmp/var_scope_debug.ps1 <<'PS1'
      Write-Host "--- GitLab Variable Scope Debug ---"
      $missing = @()

      function Check-Var($name) {
        $val = (Get-Item -Path Env:$name -ErrorAction SilentlyContinue).Value
        if ([string]::IsNullOrEmpty($val)) {
          Write-Host "$name = <EMPTY>"
          $missing += $name
        }
        else {
          Write-Host "$name = <MASKED: length $($val.Length)>"
        }
      }

      Check-Var "WINDOWS_USER"
      Check-Var "WINDOWS_PASS"
      Check-Var "WINDOWS_HOST"

      if ($missing.Count -gt 0) {
        Write-Error "❌ Missing required variables: $($missing -join ', ')"
        exit 1
      }

      Write-Host "--- All required variables are present ---"
      PS1
    - pwsh -NoLogo -NonInteractive -File /tmp/var_scope_debug.ps1

connect_windows:
  stage: connect
  image: $POWERSHELL_IMAGE
  script:
    # Install OpenSSH client & netcat for SSH connectivity check
    - apt-get update -y && apt-get install -y openssh-client netcat-openbsd

    # Test SSH port availability
    - echo "Checking SSH connectivity to $WINDOWS_HOST:22..."
    - if ! nc -z -w5 "$WINDOWS_HOST" 22; then
        echo "❌ SSH port 22 is not reachable on $WINDOWS_HOST";
        exit 1;
      fi
    - echo "✅ SSH port is open, proceeding to PowerShell remoting"

    # Create PowerShell script for SSH-based remoting
    - |
      cat >/tmp/connect_windows.ps1 <<'PS1'
      $secpass = ConvertTo-SecureString $env:WINDOWS_PASS -AsPlainText -Force
      $cred    = New-Object System.Management.Automation.PSCredential ($env:WINDOWS_USER, $secpass)

      Write-Host "Attempting SSH-based PowerShell remoting to $env:WINDOWS_HOST ..."
      try {
        $session = New-PSSession -HostName $env:WINDOWS_HOST -UserName $env:WINDOWS_USER -SSHTransport
        Invoke-Command -Session $session -ScriptBlock { whoami }
        Remove-PSSession $session
      }
      catch {
        Write-Error "❌ SSH connection failed: $($_.Exception.Message)"
        exit 1
      }
      PS1

    # Execute PowerShell connection
    - pwsh -NoLogo -NonInteractive -File /tmp/connect_windows.ps1
  needs:
    - job: debug_gitlab_vars
      artifacts: false
