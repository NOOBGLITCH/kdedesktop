stages:
  - debug
  - connect

variables:
  POWERSHELL_IMAGE: "mcr.microsoft.com/powershell:latest"

debug_gitlab_vars:
  stage: debug
  image: $POWERSHELL_IMAGE
  script:
    - |
      cat >/tmp/var_scope_debug.ps1 <<'PS1'
      Write-Host "--- GitLab Variable Scope Debug ---"
      Write-Host "Project: $env:CI_PROJECT_NAME"
      Write-Host "Branch:  $env:CI_COMMIT_BRANCH"
      Write-Host "Default Branch: $env:CI_DEFAULT_BRANCH"
      Write-Host "Pipeline Source: $env:CI_PIPELINE_SOURCE"
      Write-Host "Protected Branch? " -NoNewline
      if ($env:CI_COMMIT_REF_PROTECTED -eq "true") {
        Write-Host "✅ Yes"
      }
      else {
        Write-Host "❌ No"
      }

      $missing = @()
      function Check-Var($name) {
        $val = (Get-Item -Path Env:$name -ErrorAction SilentlyContinue).Value
        if ([string]::IsNullOrEmpty($val)) {
          Write-Host "$name = <EMPTY>"
          $missing += $name
        }
        else {
          Write-Host "$name = <MASKED: length $($val.Length)>"
        }
      }

      Check-Var "WINDOWS_USER"
      Check-Var "WINDOWS_PASS"
      Check-Var "WINDOWS_HOST"

      if ($missing.Count -gt 0) {
        Write-Error "❌ Missing required variables: $($missing -join ', ')"
        exit 1
      }

      Write-Host "--- All required variables are present ---"
      PS1
    - pwsh -NoLogo -NonInteractive -File /tmp/var_scope_debug.ps1

connect_windows:
  stage: connect
  image: $POWERSHELL_IMAGE
  script:
    - |
      cat >/tmp/connect_windows.ps1 <<'PS1'
      $secpass = ConvertTo-SecureString $env:WINDOWS_PASS -AsPlainText -Force
      $cred    = New-Object System.Management.Automation.PSCredential ($env:WINDOWS_USER, $secpass)

      Write-Host "Attempting to connect to $env:WINDOWS_HOST as $env:WINDOWS_USER ..."
      try {
        Invoke-Command -ComputerName $env:WINDOWS_HOST -Credential $cred -ScriptBlock { whoami }
      }
      catch {
        Write-Error "Remote connection failed: $($_.Exception.Message)"
        exit 1
      }
      PS1
    - pwsh -NoLogo -NonInteractive -File /tmp/connect_windows.ps1
  needs:
    - job: debug_gitlab_vars
      artifacts: false
